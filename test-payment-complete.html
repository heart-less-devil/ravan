<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Payment Test</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .container { background: #f9f9f9; padding: 30px; border-radius: 10px; }
        .success { color: green; background: #e6ffe6; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .error { color: red; background: #ffe6e6; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .warning { color: orange; background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #card-element { border: 1px solid #ddd; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .test-section { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Complete Payment System Test</h1>
        
        <div class="test-section">
            <h3>Step 1: Test Stripe Keys</h3>
            <button onclick="testStripeKeys()">Test Stripe Keys</button>
            <div id="stripe-test-result"></div>
        </div>

        <div class="test-section">
            <h3>Step 2: Test Payment Method Creation</h3>
            <div id="card-element">
                <!-- Stripe Elements will create form elements here -->
            </div>
            <div id="card-errors" role="alert"></div>
            <button id="test-payment-method" disabled>Test Payment Method</button>
            <div id="payment-method-result"></div>
        </div>

        <div class="test-section">
            <h3>Step 3: Test Backend Connection</h3>
            <button onclick="testBackendConnection()">Test Backend</button>
            <div id="backend-test-result"></div>
        </div>

        <div class="test-section">
            <h3>Step 4: Test Complete Payment Flow</h3>
            <button id="test-complete-payment" disabled>Test Complete Payment ($1.00)</button>
            <div id="complete-payment-result"></div>
        </div>

        <div class="test-section">
            <h3>Test Cards</h3>
            <div style="background: #e8f4fd; padding: 15px; border-radius: 5px;">
                <strong>Use these test cards:</strong><br>
                ‚úÖ Success: <code>4242 4242 4242 4242</code><br>
                ‚ùå Declined: <code>4000 0000 0000 0002</code><br>
                üîê 3D Secure: <code>4000 0025 0000 3155</code><br>
                <br>
                <strong>Expiry:</strong> Any future date (e.g., 12/25)<br>
                <strong>CVC:</strong> Any 3 digits (e.g., 123)
            </div>
        </div>
    </div>

    <script>
        let stripe, elements, cardElement;
        let stripePublishableKey = 'pk_live_51RlErgLf1iznKy11bUQ4zowN63lhfc2ElpXY9stuz1XqzBBJcWHHWzczvSUfVAxkFQiOTFfzaDzD38WMzBKCAlJA00lB6CGJwT';

        function testStripeKeys() {
            const resultDiv = document.getElementById('stripe-test-result');
            
            try {
                // Test if Stripe can be initialized
                stripe = Stripe(stripePublishableKey);
                elements = stripe.elements();
                
                resultDiv.innerHTML = '<div class="success">‚úÖ Stripe keys are valid and working!</div>';
                resultDiv.innerHTML += '<div class="success">‚úÖ Stripe initialized successfully</div>';
                resultDiv.innerHTML += '<div class="success">‚úÖ Elements created successfully</div>';
                
                // Initialize card element
                initializeCardElement();
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Stripe Error: ${error.message}</div>`;
            }
        }

        function initializeCardElement() {
            cardElement = elements.create('card', {
                style: {
                    base: {
                        fontSize: '16px',
                        color: '#424770',
                        '::placeholder': {
                            color: '#aab7c4',
                        },
                    },
                    invalid: {
                        color: '#9e2146',
                    },
                },
            });

            cardElement.mount('#card-element');

            // Handle real-time validation errors
            cardElement.on('change', function(event) {
                const displayError = document.getElementById('card-errors');
                if (event.error) {
                    displayError.textContent = event.error.message;
                    document.getElementById('test-payment-method').disabled = true;
                } else {
                    displayError.textContent = '';
                    document.getElementById('test-payment-method').disabled = false;
                }
            });

            // Set up payment method test
            document.getElementById('test-payment-method').addEventListener('click', testPaymentMethod);
        }

        async function testPaymentMethod() {
            const resultDiv = document.getElementById('payment-method-result');
            const button = document.getElementById('test-payment-method');
            
            button.disabled = true;
            button.textContent = 'Testing...';
            
            try {
                const { error: pmError, paymentMethod } = await stripe.createPaymentMethod({
                    type: 'card',
                    card: cardElement,
                    billing_details: {
                        name: 'Test User',
                        email: 'test@example.com',
                    }
                });

                if (pmError) {
                    resultDiv.innerHTML = `<div class="error">‚ùå Payment Method Error: ${pmError.message}</div>`;
                    resultDiv.innerHTML += `<div class="error">Error Type: ${pmError.type}</div>`;
                    resultDiv.innerHTML += `<div class="error">Error Code: ${pmError.code || 'N/A'}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="success">‚úÖ Payment Method Created Successfully!</div>`;
                    resultDiv.innerHTML += `<div class="success">ID: ${paymentMethod.id}</div>`;
                    resultDiv.innerHTML += `<div class="success">Card Type: ${paymentMethod.card.brand.toUpperCase()}</div>`;
                    resultDiv.innerHTML += `<div class="success">Last 4: ****${paymentMethod.card.last4}</div>`;
                    
                    // Enable complete payment test
                    document.getElementById('test-complete-payment').disabled = false;
                }

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Unexpected Error: ${error.message}</div>`;
            }

            button.disabled = false;
            button.textContent = 'Test Payment Method';
        }

        async function testBackendConnection() {
            const resultDiv = document.getElementById('backend-test-result');
            
            try {
                const response = await fetch('http://localhost:3005/api/health');
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = '<div class="success">‚úÖ Backend connection successful!</div>';
                    resultDiv.innerHTML += `<div class="success">Server: ${data.message}</div>`;
                    resultDiv.innerHTML += `<div class="success">Status: ${data.status}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Backend Error: ${response.status}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Backend Connection Failed: ${error.message}</div>`;
            }
        }

        // Set up complete payment test
        document.getElementById('test-complete-payment').addEventListener('click', async function() {
            const resultDiv = document.getElementById('complete-payment-result');
            const button = document.getElementById('test-complete-payment');
            
            button.disabled = true;
            button.textContent = 'Processing...';
            
            try {
                // Create payment method first
                const { error: pmError, paymentMethod } = await stripe.createPaymentMethod({
                    type: 'card',
                    card: cardElement,
                    billing_details: {
                        name: 'Test User',
                        email: 'test@example.com',
                    }
                });

                if (pmError) {
                    resultDiv.innerHTML = `<div class="error">‚ùå Payment Method Error: ${pmError.message}</div>`;
                    return;
                }

                // Create payment intent
                const response = await fetch('http://localhost:3005/api/create-payment-intent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: 1.00,
                        currency: 'usd',
                        planId: 'test',
                        isAnnual: false,
                        customerEmail: 'test@example.com'
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    resultDiv.innerHTML = `<div class="error">‚ùå Payment Intent Error: ${response.status} ${errorData}</div>`;
                    return;
                }

                const { clientSecret } = await response.json();

                // Confirm payment
                const { error: paymentError, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
                    payment_method: paymentMethod.id,
                });

                if (paymentError) {
                    resultDiv.innerHTML = `<div class="error">‚ùå Payment Confirmation Error: ${paymentError.message}</div>`;
                } else {
                    resultDiv.innerHTML = '<div class="success">üéâ Complete Payment Successful!</div>';
                    resultDiv.innerHTML += `<div class="success">Payment ID: ${paymentIntent.id}</div>`;
                    resultDiv.innerHTML += `<div class="success">Amount: $${paymentIntent.amount / 100}</div>`;
                    resultDiv.innerHTML += `<div class="success">Status: ${paymentIntent.status}</div>`;
                }

            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Complete Payment Error: ${error.message}</div>`;
            }

            button.disabled = false;
            button.textContent = 'Test Complete Payment ($1.00)';
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('stripe-test-result').innerHTML = `
                <div class="warning">
                    <strong>Instructions:</strong><br>
                    1. Click "Test Stripe Keys" first<br>
                    2. Use test card numbers in the form<br>
                    3. Test each step in order<br>
                    4. Check console for detailed logs
                </div>
            `;
        });
    </script>
</body>
</html>
